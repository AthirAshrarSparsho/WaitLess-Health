<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Clinic Wait Time Finder | Professional</title>
  <meta name="description" content="Find nearby walk-in clinics, compare wait times, hours, distance, and services." />
  <meta name="theme-color" content="#0f172a" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin="anonymous"
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin="anonymous"
  ></script>

  <style>
    :root{
      --bg:#f4f8ff;
      --ink:#0f172a;
      --muted:#5b6b85;
      --line:#d7e2f3;
      --card:#ffffff;
      --card2:#f8fbff;
      --primary:#2f6df6;
      --primary-2:#2156cc;
      --accent:#19b8a8;
      --good:#0ea55a;
      --warn:#d97706;
      --bad:#dc2626;
      --shadow:0 20px 50px rgba(15,23,42,0.08);
      --radius:18px;
      --radius-sm:12px;
      --max:1280px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background: radial-gradient(1200px 500px at 10% -10%, #d9e7ff 0%, transparent 60%),
                  radial-gradient(900px 500px at 110% -15%, #d5fff5 0%, transparent 60%),
                  var(--bg);
      min-height:100%;
    }

    .container{
      max-width:var(--max);
      margin:0 auto;
      padding:0 18px;
    }

    /* Top Nav */
    .topbar{
      position:sticky;
      top:0;
      z-index:1200;
      backdrop-filter: blur(10px);
      background:rgba(244,248,255,0.75);
      border-bottom:1px solid rgba(15,23,42,.08);
    }
    .topbar-inner{
      height:72px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }
    .logo{
      width:40px;height:40px;border-radius:12px;
      background:linear-gradient(145deg,#2f6df6,#19b8a8);
      box-shadow:0 8px 20px rgba(47,109,246,.35);
      display:grid;place-items:center;color:#fff;font-weight:800;font-size:18px;
      flex:0 0 auto;
    }
    .brand h1{
      margin:0;font-size:17px;line-height:1.15;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .brand small{display:block;color:var(--muted);font-size:12px;margin-top:2px}

    .top-actions{
      display:flex;gap:10px;flex-wrap:wrap;
    }

    .btn{
      border:none;
      background:var(--card);
      color:var(--ink);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 13px;
      font-weight:600;
      cursor:pointer;
      transition:.18s ease;
      display:inline-flex;align-items:center;gap:8px;
      box-shadow:0 3px 12px rgba(15,23,42,.04);
    }
    .btn:hover{transform:translateY(-1px);box-shadow:0 8px 18px rgba(15,23,42,.08)}
    .btn.primary{
      background:linear-gradient(135deg,var(--primary),#4a82ff);
      color:#fff;
      border-color:transparent;
      box-shadow:0 10px 24px rgba(47,109,246,.30);
    }
    .btn.primary:hover{background:linear-gradient(135deg,var(--primary-2),var(--primary))}
    .btn.ghost{
      background:transparent;
      border-color:#c9d8f0;
    }
    .btn.danger{
      color:#b91c1c;
      background:#fff5f5;
      border-color:#ffd8d8;
    }

    /* Hero */
    .hero{
      margin-top:16px;
      border-radius:24px;
      padding:24px;
      background:
        radial-gradient(900px 300px at 0% 0%, rgba(47,109,246,.22), transparent 70%),
        radial-gradient(700px 280px at 100% 0%, rgba(25,184,168,.22), transparent 70%),
        linear-gradient(180deg,#eef4ff,#f8fffd);
      border:1px solid #dbe7fb;
      box-shadow:var(--shadow);
    }
    .hero h2{
      margin:0;
      font-size:clamp(22px,3vw,32px);
      line-height:1.2;
      letter-spacing:-.02em;
    }
    .hero p{
      margin:10px 0 0;
      color:var(--muted);
      font-size:15px;
      max-width:820px;
    }

    /* Search + Controls strip */
    .controls{
      margin-top:16px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:20px;
      box-shadow:var(--shadow);
      padding:14px;
    }

    .search-row{
      display:grid;
      grid-template-columns: 1fr auto auto;
      gap:10px;
      align-items:center;
    }

    .input-wrap{
      position:relative;
      min-width:0;
    }
    .search{
      width:100%;
      border:1px solid var(--line);
      border-radius:14px;
      padding:13px 14px 13px 42px;
      font-size:15px;
      background:#fff;
      outline:none;
      transition:.15s ease;
    }
    .search:focus{
      border-color:#a6c2ff;
      box-shadow:0 0 0 4px rgba(47,109,246,.12);
    }
    .search-icon{
      position:absolute;left:13px;top:50%;transform:translateY(-50%);
      opacity:.55;
      width:18px;height:18px;
    }

    /* Suggestion dropdown */
    .suggest{
      position:absolute;
      top:calc(100% + 8px);
      left:0;right:0;
      background:#fff;
      border:1px solid #d5e3fb;
      border-radius:14px;
      box-shadow:0 18px 40px rgba(15,23,42,.15);
      overflow:hidden;
      display:none;
      z-index:1400;
    }
    .s-row{
      padding:10px 12px;
      border-top:1px solid #edf3ff;
      cursor:pointer;
      transition:.12s;
    }
    .s-row:first-child{border-top:none}
    .s-row:hover,.s-row.active{background:#f5f9ff}
    .s-title{font-size:14px;font-weight:600}
    .s-sub{font-size:12px;color:var(--muted);margin-top:2px}

    .filter-row{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(6,minmax(0,1fr));
      gap:10px;
    }

    .field{
      background:var(--card2);
      border:1px solid #dee8f8;
      border-radius:14px;
      padding:10px 11px;
      min-width:0;
    }
    .field label{
      display:block;
      font-size:11px;
      color:var(--muted);
      margin-bottom:6px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:.03em;
    }
    .field select,.field input[type="range"]{
      width:100%;
      border:none;
      background:transparent;
      outline:none;
      font-size:14px;
      color:var(--ink);
    }
    .mini{
      margin-top:5px;
      font-size:12px;
      color:var(--muted);
      display:flex;justify-content:space-between;
    }

    .services{
      margin-top:12px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .chip{
      border:1px solid #d6e3f8;
      background:#fff;
      color:#27405f;
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      transition:.12s;
      user-select:none;
    }
    .chip:hover{transform:translateY(-1px)}
    .chip.on{
      background:#eaf1ff;
      border-color:#aac5ff;
      color:#20428f;
    }

    /* Main Content Area */
    .workspace{
      margin-top:16px;
      display:grid;
      grid-template-columns: 44% 56%;
      gap:14px;
      min-height:640px;
    }

    .panel{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:20px;
      box-shadow:var(--shadow);
      overflow:hidden;
      min-height:0;
    }

    /* Results panel */
    .results-head{
      padding:14px 14px 10px;
      border-bottom:1px solid #e6eefb;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      flex-wrap:wrap;
      background:linear-gradient(180deg,#f8fbff,#fff);
    }
    .stats{
      display:flex;gap:10px;flex-wrap:wrap;
    }
    .stat{
      background:#f5f9ff;
      border:1px solid #dce8fa;
      border-radius:12px;
      padding:8px 10px;
      min-width:120px;
    }
    .stat .k{font-size:11px;color:var(--muted)}
    .stat .v{font-size:16px;font-weight:800;margin-top:2px}

    .results-list{
      max-height:calc(640px - 74px);
      overflow:auto;
      padding:12px;
      background:#fcfeff;
    }

    .card{
      border:1px solid #dde8fb;
      background:#fff;
      border-radius:16px;
      padding:12px;
      margin-bottom:10px;
      transition:.15s;
      cursor:pointer;
    }
    .card:hover{transform:translateY(-1px);box-shadow:0 10px 20px rgba(15,23,42,.08)}
    .card.active{
      border-color:#8eb2ff;
      box-shadow:0 0 0 4px rgba(47,109,246,.12);
      background:#f8fbff;
    }
    .card-top{
      display:flex;justify-content:space-between;gap:10px;align-items:flex-start;
    }
    .title{
      margin:0;
      font-size:16px;
      line-height:1.2;
      font-weight:800;
      letter-spacing:-.01em;
    }
    .address{
      margin-top:4px;
      color:var(--muted);
      font-size:13px;
    }

    .badge{
      border-radius:999px;
      padding:6px 9px;
      font-size:12px;
      font-weight:700;
      white-space:nowrap;
      border:1px solid transparent;
    }
    .wait-good{background:#ebfff4;color:#0b7a44;border-color:#b8f1d3}
    .wait-warn{background:#fff8eb;color:#8a4e06;border-color:#f8dfb7}
    .wait-bad{background:#fff0f0;color:#991b1b;border-color:#fecaca}
    .open{background:#eafff7;color:#0f766e;border:1px solid #b6f2e8}
    .closing{background:#fff8ec;color:#9a5900;border:1px solid #ffe0b8}
    .closed{background:#f4f4f5;color:#52525b;border:1px solid #e4e4e7}

    .meta{
      margin-top:10px;
      display:flex;gap:8px;flex-wrap:wrap;
    }
    .pill{
      font-size:12px;
      color:#334155;
      border:1px solid #d9e4f6;
      background:#f6faff;
      border-radius:999px;
      padding:6px 9px;
    }

    .actions{
      margin-top:10px;
      display:flex;gap:8px;flex-wrap:wrap;
    }

    /* Map panel */
    .map-wrap{
      position:relative;
      min-height:640px;
    }
    #map{
      width:100%;
      height:640px;
      border-radius:20px;
    }

    .map-hud{
      position:absolute;
      top:12px;left:12px;z-index:500;
      display:flex;gap:8px;flex-wrap:wrap;
    }
    .hud{
      font-size:12px;
      background:rgba(255,255,255,.92);
      border:1px solid #d7e4f8;
      border-radius:999px;
      padding:7px 10px;
      box-shadow:0 8px 20px rgba(15,23,42,.08);
      color:#334155;
    }

    .map-tools{
      position:absolute;
      top:12px;right:12px;z-index:500;
      display:flex;flex-direction:column;gap:8px;
    }

    .toast{
      position:fixed;
      left:50%;transform:translateX(-50%);
      bottom:16px;
      z-index:2200;
      background:#0f172a;
      color:#fff;
      border-radius:12px;
      padding:10px 14px;
      box-shadow:0 16px 30px rgba(2,6,23,.35);
      display:none;
      font-size:13px;
      max-width:min(92vw,860px);
    }

    footer{
      margin:16px 0 24px;
      color:#60708b;
      font-size:12px;
      text-align:center;
    }

    /* Responsive */
    @media (max-width:1180px){
      .filter-row{grid-template-columns:repeat(3,minmax(0,1fr))}
      .workspace{grid-template-columns:1fr;min-height:unset}
      #map,.map-wrap{height:520px;min-height:520px}
      .results-list{max-height:unset}
    }
    @media (max-width:760px){
      .topbar-inner{height:auto;padding:10px 0}
      .search-row{grid-template-columns:1fr}
      .filter-row{grid-template-columns:repeat(2,minmax(0,1fr))}
      .hero{padding:18px}
      #map,.map-wrap{height:430px;min-height:430px}
    }
    @media (max-width:520px){
      .filter-row{grid-template-columns:1fr}
      .stat{min-width:unset}
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="container topbar-inner">
      <div class="brand">
        <div class="logo">+</div>
        <div>
          <h1>Clinic Wait Time Finder</h1>
          <small>Professional edition</small>
        </div>
      </div>
      <div class="top-actions">
        <button class="btn primary" id="btnUseLocation">Use My Location</button>
        <button class="btn" id="btnFitMap">Fit Results</button>
        <button class="btn danger" id="btnReset">Reset</button>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <h2>Find nearby clinics with smarter wait-time estimates</h2>
      <p>
        Search any address, compare clinics by wait time, distance, open status, and services.
        Designed for speed, clarity, and real-world usability.
      </p>
    </section>

    <section class="controls">
      <div class="search-row">
        <div class="input-wrap">
          <svg class="search-icon" viewBox="0 0 24 24" fill="none">
            <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="1.9"/>
            <path d="M16.5 16.5 21 21" stroke="currentColor" stroke-width="1.9" stroke-linecap="round"/>
          </svg>
          <input id="addressInput" class="search" placeholder="Search address or city (e.g., 482 Front St W, Toronto)" />
          <div class="suggest" id="suggest"></div>
        </div>
        <button class="btn primary" id="btnSearch">Search</button>
        <button class="btn ghost" id="btnCenter">Center Map</button>
      </div>

      <div class="filter-row">
        <div class="field">
          <label>Sort By</label>
          <select id="sortBy">
            <option value="best">Best Overall</option>
            <option value="wait">Shortest Wait</option>
            <option value="distance">Closest</option>
            <option value="rating">Highest Rating</option>
            <option value="updated">Most Recently Updated</option>
          </select>
        </div>

        <div class="field">
          <label>Hours</label>
          <select id="hoursFilter">
            <option value="any">Any</option>
            <option value="open">Open Now</option>
            <option value="closing">Closing Soon</option>
          </select>
        </div>

        <div class="field">
          <label>Max Distance (km)</label>
          <input type="range" id="distanceRange" min="1" max="30" value="12" />
          <div class="mini"><span>1</span><span id="distanceLabel">12 km</span><span>30</span></div>
        </div>

        <div class="field">
          <label>Max Wait (min)</label>
          <input type="range" id="waitRange" min="0" max="240" value="120" />
          <div class="mini"><span>0</span><span id="waitLabel">120 min</span><span>240</span></div>
        </div>

        <div class="field">
          <label>Report Influence</label>
          <select id="reportMode">
            <option value="on">ON</option>
            <option value="off">OFF</option>
          </select>
        </div>

        <div class="field">
          <label>Area</label>
          <div id="nearText" style="font-size:14px;font-weight:700;line-height:1.35">Toronto, ON</div>
        </div>
      </div>

      <div class="services" id="serviceChips"></div>
    </section>

    <section class="workspace">
      <div class="panel">
        <div class="results-head">
          <div>
            <div style="font-size:12px;color:var(--muted);font-weight:600">Clinic results</div>
            <div style="font-size:18px;font-weight:800;margin-top:2px">Nearby Options</div>
          </div>
          <div class="stats">
            <div class="stat">
              <div class="k">Results</div>
              <div class="v" id="statCount">0</div>
            </div>
            <div class="stat">
              <div class="k">Best Match</div>
              <div class="v" id="statBest">—</div>
            </div>
          </div>
        </div>
        <div class="results-list" id="resultsList"></div>
      </div>

      <div class="panel map-wrap">
        <div class="map-hud">
          <div class="hud">Tip: Select a clinic card to highlight on map</div>
          <div class="hud">Wait times are estimated</div>
        </div>
        <div class="map-tools">
          <button class="btn" id="btnZoomResults">Zoom to Results</button>
        </div>
        <div id="map"></div>
      </div>
    </section>

    <footer>
      © 2026 Athir Global Partners · Data source: demo clinics + OpenStreetMap geocoding
    </footer>
  </main>

  <div id="toast" class="toast"></div>

  <script>
    const $ = (s) => document.querySelector(s);
    const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));

    function showToast(msg){
      const t = $("#toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(showToast._timer);
      showToast._timer = setTimeout(() => t.style.display = "none", 2800);
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[s]));
    }

    function haversine(lat1, lon1, lat2, lon2){
      const R = 6371;
      const toRad = (x)=>x*Math.PI/180;
      const dLat = toRad(lat2-lat1);
      const dLon = toRad(lon2-lon1);
      const a = Math.sin(dLat/2)**2 +
                Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function fmtDist(km){
      return km < 1 ? `${Math.round(km*1000)} m` : `${km.toFixed(km<10?1:0)} km`;
    }

    const DAY = ["sun","mon","tue","wed","thu","fri","sat"];
    function parseHM(hm){
      const [h,m] = hm.split(":").map(Number);
      return h*60 + m;
    }
    function openInfo(hours){
      const now = new Date();
      const key = DAY[now.getDay()];
      const range = hours[key];
      if(!range) return {state:"closed", text:"Closed", closingIn:null};
      const cur = now.getHours()*60 + now.getMinutes();
      const open = parseHM(range[0]);
      const close = parseHM(range[1]);
      if(cur < open || cur >= close) return {state:"closed", text:"Closed", closingIn:null};
      const left = close - cur;
      if(left <= 60) return {state:"closing", text:`Closing in ${left}m`, closingIn:left};
      return {state:"open", text:"Open now", closingIn:left};
    }

    function waitClass(min){
      if(min <= 25) return "wait-good";
      if(min <= 60) return "wait-warn";
      return "wait-bad";
    }

    const BASE_CLINICS = [
      {
        id:"c1",
        name:"Front & Spadina Walk-In Clinic",
        address:"Front St W & Spadina Ave, Toronto, ON",
        lat:43.64262,lng:-79.38705,
        services:["Walk-in","Family Doctor","Vaccines","Bloodwork"],
        rating:4.4, baseWait:35, updatedAt:new Date(Date.now()-40*60000).toISOString(),
        hours:{mon:["09:00","19:00"],tue:["09:00","19:00"],wed:["09:00","19:00"],thu:["09:00","19:00"],fri:["09:00","18:00"],sat:["10:00","16:00"],sun:null}
      },
      {
        id:"c2",
        name:"Downtown Urgent Care (Non-ER)",
        address:"Bay St, Toronto, ON",
        lat:43.6539,lng:-79.3853,
        services:["Urgent Care","Minor Injuries","Stitches"],
        rating:4.6, baseWait:26, updatedAt:new Date(Date.now()-22*60000).toISOString(),
        hours:{mon:["08:00","22:00"],tue:["08:00","22:00"],wed:["08:00","22:00"],thu:["08:00","22:00"],fri:["08:00","22:00"],sat:["09:00","20:00"],sun:["09:00","20:00"]}
      },
      {
        id:"c3",
        name:"Queen West Medical Walk-In",
        address:"Queen St W, Toronto, ON",
        lat:43.64842,lng:-79.40415,
        services:["Walk-in","STD Testing","Prescriptions"],
        rating:4.1, baseWait:51, updatedAt:new Date(Date.now()-85*60000).toISOString(),
        hours:{mon:["10:00","20:00"],tue:["10:00","20:00"],wed:["10:00","20:00"],thu:["10:00","20:00"],fri:["10:00","19:00"],sat:["10:00","17:00"],sun:["11:00","16:00"]}
      },
      {
        id:"c4",
        name:"Harbourfront Family Health",
        address:"Harbour St, Toronto, ON",
        lat:43.64075,lng:-79.38192,
        services:["Family Doctor","Walk-in","Referrals","Vaccines"],
        rating:4.3, baseWait:44, updatedAt:new Date(Date.now()-130*60000).toISOString(),
        hours:{mon:["09:00","17:00"],tue:["09:00","17:00"],wed:["09:00","17:00"],thu:["09:00","17:00"],fri:["09:00","17:00"],sat:null,sun:null}
      },
      {
        id:"c5",
        name:"Bloor-Yonge Walk-In & Diagnostics",
        address:"Bloor St E, Toronto, ON",
        lat:43.67170,lng:-79.38668,
        services:["Walk-in","Bloodwork","Forms"],
        rating:4.0, baseWait:62, updatedAt:new Date(Date.now()-56*60000).toISOString(),
        hours:{mon:["08:30","18:30"],tue:["08:30","18:30"],wed:["08:30","18:30"],thu:["08:30","18:30"],fri:["08:30","18:00"],sat:["09:00","14:00"],sun:null}
      }
    ];

    const ALL_SERVICES = ["Walk-in","Urgent Care","Family Doctor","Minor Injuries","Vaccines","Bloodwork","STD Testing","Prescriptions","Referrals","Forms","Stitches"];

    const state = {
      center:{lat:43.6532,lng:-79.3832,label:"Toronto, ON"},
      sort:"best",
      hours:"any",
      maxDist:12,
      maxWait:120,
      selectedServices:new Set(),
      reportMode:true,
      highlight:null
    };

    // Map
    const map = L.map("map");
    L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{
      maxZoom:19,
      attribution:"&copy; OpenStreetMap contributors"
    }).addTo(map);
    map.setView([state.center.lat,state.center.lng],13);

    let markersLayer = L.layerGroup().addTo(map);
    let centerMarker = null;
    let highlightCircle = null;
    let rendered = [];

    function setCenter(lat,lng,label){
      state.center = {lat,lng,label};
      $("#nearText").textContent = label || `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
      map.setView([lat,lng],13,{animate:true});
      if(centerMarker) centerMarker.remove();
      centerMarker = L.circleMarker([lat,lng],{
        radius:7, color:"#2f6df6", fillColor:"#2f6df6", fillOpacity:0.2, weight:2
      }).addTo(map);
      refresh();
    }

    function estimateWait(c){
      let w = c.baseWait;
      const minsOld = (Date.now() - new Date(c.updatedAt).getTime())/60000;
      w += clamp((minsOld - 30)/8,0,20);

      // time-of-day demand pattern
      const h = new Date().getHours() + new Date().getMinutes()/60;
      w += Math.exp(-Math.pow((h-11)/2.8,2))*14 + Math.exp(-Math.pow((h-18)/2.4,2))*12;

      if(!state.reportMode) w -= 4;
      return clamp(w,0,240);
    }

    function compute(){
      return BASE_CLINICS.map(c=>{
        const d = haversine(state.center.lat,state.center.lng,c.lat,c.lng);
        const wait = estimateWait(c);
        const open = openInfo(c.hours);
        const score = d*3.1 + wait*1.0 + (5-c.rating)*5 + (open.state==="closed"?16:open.state==="closing"?5:-8);
        return {...c,_dist:d,_wait:wait,_open:open,_score:score};
      });
    }

    function passes(c){
      if(c._dist > state.maxDist) return false;
      if(c._wait > state.maxWait) return false;
      if(state.hours==="open" && !(c._open.state==="open" || c._open.state==="closing")) return false;
      if(state.hours==="closing" && c._open.state!=="closing") return false;
      if(state.selectedServices.size){
        const s = new Set(c.services);
        for(const x of state.selectedServices) if(!s.has(x)) return false;
      }
      return true;
    }

    function sortClinics(arr){
      const out = [...arr];
      if(state.sort==="wait") out.sort((a,b)=>a._wait-b._wait);
      else if(state.sort==="distance") out.sort((a,b)=>a._dist-b._dist);
      else if(state.sort==="rating") out.sort((a,b)=>b.rating-a.rating);
      else if(state.sort==="updated") out.sort((a,b)=>new Date(b.updatedAt)-new Date(a.updatedAt));
      else out.sort((a,b)=>a._score-b._score);
      return out;
    }

    function renderServices(){
      const host = $("#serviceChips");
      host.innerHTML = "";
      ALL_SERVICES.forEach(s=>{
        const el = document.createElement("div");
        el.className = "chip" + (state.selectedServices.has(s) ? " on":"");
        el.textContent = s;
        el.onclick = ()=>{
          if(state.selectedServices.has(s)) state.selectedServices.delete(s);
          else state.selectedServices.add(s);
          renderServices();
          refresh();
        };
        host.appendChild(el);
      });
    }

    function renderMap(list){
      markersLayer.clearLayers();
      list.forEach(c=>{
        const color = c._open.state==="closed" ? "#9ca3af" :
                      c._wait<=25 ? "#0ea55a" :
                      c._wait<=60 ? "#d97706" : "#dc2626";

        const marker = L.circleMarker([c.lat,c.lng],{
          radius: state.highlight===c.id ? 10 : 7,
          color, fillColor:color, fillOpacity:0.28, weight:2
        }).addTo(markersLayer);

        marker.bindPopup(`
          <div style="font-family:Inter,system-ui;min-width:220px">
            <div style="font-weight:800;margin-bottom:4px">${escapeHtml(c.name)}</div>
            <div style="font-size:12px;color:#475569;margin-bottom:8px">${escapeHtml(c.address)}</div>
            <div style="font-size:12px">
              <b>Wait:</b> ~${Math.round(c._wait)} min<br>
              <b>Distance:</b> ${fmtDist(c._dist)}<br>
              <b>Status:</b> ${escapeHtml(c._open.text)}
            </div>
          </div>
        `);

        marker.on("click",()=>{
          state.highlight = c.id;
          focusClinic(c.id, false);
        });
      });
    }

    function renderList(list){
      const host = $("#resultsList");
      host.innerHTML = "";

      $("#statCount").textContent = list.length;
      $("#statBest").textContent = list.length ? (list[0].name.length>16 ? list[0].name.slice(0,16)+"…" : list[0].name) : "—";

      if(!list.length){
        host.innerHTML = `
          <div class="card">
            <h3 class="title">No clinics match your filters</h3>
            <div class="address">Try increasing max distance/wait or removing service filters.</div>
          </div>
        `;
        return;
      }

      list.forEach(c=>{
        const card = document.createElement("article");
        card.className = "card" + (state.highlight===c.id ? " active":"");
        const wClass = waitClass(c._wait);
        const openClass = c._open.state==="open" ? "open" : c._open.state==="closing" ? "closing" : "closed";

        card.innerHTML = `
          <div class="card-top">
            <div>
              <h3 class="title">${escapeHtml(c.name)}</h3>
              <div class="address">${escapeHtml(c.address)}</div>
            </div>
            <div class="badge ${wClass}">~${Math.round(c._wait)} min</div>
          </div>

          <div class="meta">
            <div class="pill">Distance: ${fmtDist(c._dist)}</div>
            <div class="pill">Rating: ${c.rating.toFixed(1)}</div>
            <div class="badge ${openClass}">${escapeHtml(c._open.text)}</div>
          </div>

          <div class="meta" style="margin-top:8px">
            ${c.services.slice(0,5).map(s=>`<div class="pill">${escapeHtml(s)}</div>`).join("")}
          </div>

          <div class="actions">
            <button class="btn" data-view="${c.id}">View on Map</button>
            <button class="btn primary" data-dir="${c.id}">Directions</button>
          </div>
        `;

        card.onclick = (e)=>{
          if(e.target.closest("button")) return;
          focusClinic(c.id, true);
        };
        host.appendChild(card);
      });

      host.querySelectorAll("[data-view]").forEach(btn=>{
        btn.onclick = (e)=>{
          e.stopPropagation();
          focusClinic(btn.dataset.view, true);
        };
      });
      host.querySelectorAll("[data-dir]").forEach(btn=>{
        btn.onclick = (e)=>{
          e.stopPropagation();
          const id = btn.dataset.dir;
          const c = rendered.find(x=>x.id===id);
          if(!c) return;
          const url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(c.lat + "," + c.lng)}`;
          window.open(url,"_blank","noopener,noreferrer");
        };
      });
    }

    function focusClinic(id, openPopup){
      const c = rendered.find(x=>x.id===id);
      if(!c) return;
      state.highlight = id;

      if(highlightCircle) highlightCircle.remove();
      highlightCircle = L.circle([c.lat,c.lng],{
        radius:260, color:"#2f6df6", weight:2, fillColor:"#2f6df6", fillOpacity:0.06
      }).addTo(map);

      map.setView([c.lat,c.lng],15,{animate:true});
      if(openPopup){
        markersLayer.eachLayer(layer=>{
          const ll = layer.getLatLng?.();
          if(ll && Math.abs(ll.lat-c.lat)<1e-6 && Math.abs(ll.lng-c.lng)<1e-6){
            layer.openPopup();
          }
        });
      }
      renderMap(rendered);
      renderList(rendered);
    }

    function zoomToResults(){
      if(!rendered.length){
        map.setView([state.center.lat,state.center.lng],13);
        return;
      }
      const bounds = L.latLngBounds(rendered.map(c=>[c.lat,c.lng]));
      map.fitBounds(bounds.pad(0.18),{animate:true});
    }

    function refresh(){
      const computed = compute().filter(passes);
      rendered = sortClinics(computed);
      renderMap(rendered);
      renderList(rendered);
      $("#distanceLabel").textContent = `${state.maxDist} km`;
      $("#waitLabel").textContent = `${state.maxWait} min`;
    }

    // Search / suggestions (Nominatim)
    const suggestEl = $("#suggest");
    let debounceTimer = null;
    let aborter = null;
    let suggestions = [];
    let activeIndex = -1;
    let lastFetch = 0;

    async function geocodeQuery(q){
      const gap = Date.now() - lastFetch;
      if(gap < 1000) await new Promise(r=>setTimeout(r, 1000-gap));
      lastFetch = Date.now();

      if(aborter) aborter.abort();
      aborter = new AbortController();

      const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&addressdetails=1&limit=6&accept-language=en&q=${encodeURIComponent(q)}`;
      const res = await fetch(url,{signal:aborter.signal,headers:{Accept:"application/json"}});
      if(!res.ok) throw new Error("Geocode failed");
      return res.json();
    }

    function hideSuggest(){
      suggestEl.style.display = "none";
      suggestions = [];
      activeIndex = -1;
    }

    function renderSuggest(items){
      suggestions = items;
      activeIndex = -1;
      if(!items.length){
        suggestEl.innerHTML = `<div class="s-row"><div class="s-title">No results</div><div class="s-sub">Try a more specific address</div></div>`;
        suggestEl.style.display = "block";
        return;
      }
      suggestEl.innerHTML = items.map((it,i)=>{
        const parts = (it.display_name || "").split(",");
        const title = parts.slice(0,2).join(",").trim();
        const sub = parts.slice(2).join(",").trim();
        return `<div class="s-row" data-i="${i}">
                  <div class="s-title">${escapeHtml(title)}</div>
                  <div class="s-sub">${escapeHtml(sub)}</div>
                </div>`;
      }).join("");
      suggestEl.style.display = "block";

      suggestEl.querySelectorAll(".s-row[data-i]").forEach(el=>{
        el.onclick = ()=>{
          const i = Number(el.dataset.i);
          chooseSuggestion(i);
        };
      });
    }

    function chooseSuggestion(i){
      const it = suggestions[i];
      if(!it) return;
      const lat = Number(it.lat), lng = Number(it.lon);
      const label = (it.display_name || "").split(",").slice(0,3).join(",").trim();
      $("#addressInput").value = it.display_name || "";
      hideSuggest();
      setCenter(lat,lng,label);
      zoomToResults();
    }

    $("#addressInput").addEventListener("input",()=>{
      const q = $("#addressInput").value.trim();
      if(q.length < 3){
        hideSuggest();
        return;
      }
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(async ()=>{
        try{
          const items = await geocodeQuery(q);
          renderSuggest(items);
        }catch(err){
          if(err.name !== "AbortError"){
            showToast("Search temporarily unavailable. Please try again.");
          }
        }
      },300);
    });

    $("#addressInput").addEventListener("keydown",(e)=>{
      if(!suggestions.length && e.key==="Enter"){
        e.preventDefault();
        $("#btnSearch").click();
        return;
      }
      if(e.key==="Escape"){ hideSuggest(); return; }

      if(e.key==="ArrowDown"){
        e.preventDefault();
        activeIndex = Math.min(activeIndex+1, suggestions.length-1);
      }else if(e.key==="ArrowUp"){
        e.preventDefault();
        activeIndex = Math.max(activeIndex-1, 0);
      }else if(e.key==="Enter"){
        if(activeIndex>=0){
          e.preventDefault();
          chooseSuggestion(activeIndex);
          return;
        }
      } else return;

      suggestEl.querySelectorAll(".s-row[data-i]").forEach(row=>row.classList.remove("active"));
      const active = suggestEl.querySelector(`.s-row[data-i="${activeIndex}"]`);
      if(active) active.classList.add("active");
    });

    document.addEventListener("click",(e)=>{
      if(!e.target.closest(".input-wrap")) hideSuggest();
    });

    $("#btnSearch").onclick = async ()=>{
      const q = $("#addressInput").value.trim();
      if(q.length < 3){
        showToast("Enter at least 3 characters");
        return;
      }
      try{
        const items = await geocodeQuery(q);
        if(!items.length){
          showToast("No address found");
          return;
        }
        const best = items[0];
        chooseSuggestion(0);
        $("#addressInput").value = best.display_name || q;
      }catch(err){
        showToast("Could not complete search");
      }
    };

    // Controls
    $("#sortBy").onchange = (e)=>{ state.sort=e.target.value; refresh(); };
    $("#hoursFilter").onchange = (e)=>{ state.hours=e.target.value; refresh(); };
    $("#distanceRange").oninput = (e)=>{ state.maxDist=Number(e.target.value); refresh(); };
    $("#waitRange").oninput = (e)=>{ state.maxWait=Number(e.target.value); refresh(); };
    $("#reportMode").onchange = (e)=>{ state.reportMode=e.target.value==="on"; refresh(); };

    $("#btnCenter").onclick = ()=> map.setView([state.center.lat,state.center.lng],13,{animate:true});
    $("#btnFitMap").onclick = ()=> zoomToResults();
    $("#btnZoomResults").onclick = ()=> zoomToResults();

    $("#btnUseLocation").onclick = ()=>{
      if(!navigator.geolocation){
        showToast("Geolocation is not supported on this device.");
        return;
      }
      showToast("Getting your location...");
      navigator.geolocation.getCurrentPosition(
        pos=>{
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          setCenter(lat,lng,"Your location");
          zoomToResults();
          showToast("Location updated");
        },
        ()=>showToast("Location access denied. Please search manually."),
        {enableHighAccuracy:true,timeout:12000,maximumAge:60000}
      );
    };

    $("#btnReset").onclick = ()=>{
      state.sort="best";
      state.hours="any";
      state.maxDist=12;
      state.maxWait=120;
      state.selectedServices = new Set();
      state.reportMode = true;
      state.highlight = null;

      $("#sortBy").value="best";
      $("#hoursFilter").value="any";
      $("#distanceRange").value=12;
      $("#waitRange").value=120;
      $("#reportMode").value="on";
      $("#addressInput").value="";

      renderServices();
      setCenter(43.6532,-79.3832,"Toronto, ON");
      showToast("Filters reset");
    };

    // Init
    renderServices();
    setCenter(state.center.lat,state.center.lng,state.center.label);
  </script>
</body>
</html>
